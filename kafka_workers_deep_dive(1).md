# Kafka-–≤–æ—Ä–∫–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è: –∏—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—Ö–∞

–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º, –∫–∞–∫ –º—ã –≤ –∫–æ–º–ø–∞–Ω–∏–∏ S.B.S. (—Å—Ç—Ä–∞—Ö–æ–≤–æ–π –±–∏–∑–Ω–µ—Å-—Å–µ—Ä–≤–∏—Å) —Ä–µ—à–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π.

## 0. –ö–∞–∫ –≤—Å—ë –Ω–∞—á–∏–Ω–∞–ª–æ—Å—å
> ¬´–£ –Ω–∞—Å –±—ã–ª **–º–æ–Ω–æ–ª–∏—Ç** –Ω–∞¬†RabbitMQ, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥ –ø–∏–∫–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π —Ç–µ—Ä—è–ª —Å–æ–±—ã—Ç–∏—è. –†–∞—Å—Å–∫–∞–∂—É, –∫–∞–∫ –º—ã –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ Kafka –∏ –¥–æ–±–∏–ª–∏—Å—å **99.98‚ÄØ% SLA** –±–µ–∑ –ø–æ—Ç–µ—Ä—å¬ª.

## 1. –ü—Ä–æ–±–ª–µ–º–∞ –≤ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–µ
*¬´10 000 —Å–æ–±—ã—Ç–∏–π –≤ —Å—É—Ç–∫–∏, RabbitMQ –¥—É–±–ª–∏—Ä—É–µ—Ç –∏ —Ç–µ—Ä—è–µ—Ç, –±–∏–∑–Ω–µ—Å –ø–ª–∞—Ç–∏—Ç —à—Ç—Ä–∞—Ñ—ã¬ª.*

### –î–µ—Ç–∞–ª–∏:
| –ß—Ç–æ | –¶–∏—Ñ—Ä–∞ |
|-----|-------|
| –ö–ª–∏–µ–Ω—Ç–æ–≤ | ‚âà 5 –º–ª–Ω |
| –°—Ç–∞—Ä—ã–π SLA | < 99 % |
| –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π | –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ, –ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è, –∞–Ω–Ω—É–ª—è—Ü–∏—è |

## 2. –¶–µ–ª—å (—á—ë—Ç–∫–æ –∏ –∏–∑–º–µ—Ä–∏–º–æ)
| –ú–µ—Ç—Ä–∏–∫–∞ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|---------|------|-------|
| –ü–æ—Ç–µ—Ä–∏/–¥—É–±–ª–∏ | ‚ö†Ô∏è –µ—Å—Ç—å | **0** (exactly-once) |
| P95 latency | 208 –º—Å | **170 –º—Å** |
| SLA | 99 % | **99.98 %** |

## 3. –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ (–ø–æ—à–∞–≥–æ–≤–æ) ‚Äî —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏ —Ç–µ—Ä–º–∏–Ω–æ–≤
1.  **–ü–µ—Ä–µ—à—ë–ª –Ω–∞ Kafka**: 3 –±—Ä–æ–∫–µ—Ä–∞ *(—Ç—Ä–∏ —É–∑–ª–∞ –±—Ä–æ–∫–µ—Ä–æ–≤ Kafka)*, **RF = 3** *(replication factor = 3 –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏)*, **`policy_id` ‚áí partition-key** *(–ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø–æ–ª–∏—Å–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π).*  
2.  **Exactly-once** *(—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è **—Å—Ç—Ä–æ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑**, –±–µ–∑ –ø–æ—Ç–µ—Ä—å –∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)*:
    *   **Idempotent producer** (`enable.idempotence=true`) *(–ø–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–æ–¥—é—Å–µ—Ä–∞ Kafka, –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∫–∞—Ö).*  
    *   **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ Kafka ‚Üí PostgreSQL** *(Kafka –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç offset –≤ —Ç–æ–π –∂–µ DB-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Äî –ª–∏–±–æ –≤—Å—ë, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ).*  
    *   **–ó–∞—á–µ–º —ç—Ç–æ—Ç —ç—Ç–∞–ø?** –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –∏–ª–∏ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ—è—Ö. –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ —Ä–∞—Å—á—ë—Ç —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø—Ä–µ–º–∏–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –∏ –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
3.  **Consumer-framework –Ω–∞ Go** *(–µ–¥–∏–Ω—ã–π ¬´—Å–∫–µ–ª–µ—Ç¬ª –¥–ª—è –∫–æ–Ω—Å—å—é–º–µ—Ä-—Å–µ—Ä–≤–∏—Å–æ–≤)*: **Sarama** *(–ø–æ–ø—É–ª—è—Ä–Ω—ã–π Kafka-–∫–ª–∏–µ–Ω—Ç –¥–ª—è Go)* + **middleware** *(–ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç—Ä–µ–π—Å–∏–Ω–≥)* + **retry** *(–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–µ)* + **DLQ** *(Dead-Letter Queue ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ –¥–ª—è ¬´–±–µ–∑–Ω–∞–¥—ë–∂–Ω—ã—Ö¬ª —Å–æ–æ–±—â–µ–Ω–∏–π).*  
    *   **–ó–∞—á–µ–º —ç—Ç–æ—Ç —ç—Ç–∞–ø?** –ß—Ç–æ–±—ã –∫–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –ø–∏—Å–∞–ª–∞ —Å–≤–æ–π ¬´–≤–µ–ª–æ—Å–∏–ø–µ–¥¬ª: —É –≤—Å–µ—Ö –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, –º–µ—Ç—Ä–∏–∫–∏, —Ç—Ä–µ–π—Å–∏–Ω–≥ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, —á—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ —Å–Ω–∏–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–≥–æ–≤.
4.  **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: **Prometheus ‚Üí Grafana** *(Prometheus —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏, Grafana —Ä–∏—Å—É–µ—Ç –¥–∞—à–±–æ—Ä–¥—ã)*; –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏: **lag** *(–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ –æ—Ç —Ö–≤–æ—Å—Ç–∞ —Ç–æ–ø–∏–∫–∞)* –∏ **throughput** *(—Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É)*.  
    *   **–ê–ª–µ—Ä—Ç—ã**: *lag > 1000* *(–µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç—ë—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ)*, *error rate > 0.1 %* *(–¥–æ–ª—è –æ—à–∏–±–æ–∫ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏).*  
5.  **CI/CD**: **–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å testcontainers-go** *(–±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –ø–æ–¥–Ω–∏–º–∞—é—â–∞—è Kafka –≤ Docker –ø—Ä—è–º–æ –≤ —Ç–µ—Å—Ç–∞—Ö)*, **rolling-updates < 30 —Å** *(Kubernetes –≤—ã–∫–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –ø–æ –æ—á–µ—Ä–µ–¥–∏, –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞).*  

## 4. –ö–∞–∫ –≤—ã–≥–ª—è–¥–µ–ª–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Å—Ö–µ–º–∞)
*   Gateway —à–ª—ë—Ç gRPC-—Å–æ–±—ã—Ç–∏–µ ‚Üí Kafka topic `auto.events`.
*   –î–≤–∞ consumer-—Å–µ—Ä–≤–∏—Å–∞:
    *   **Underwriting** ‚Äî —Ä–∞—Å—á—ë—Ç –ø—Ä–µ–º–∏–π.
    *   **Billing** ‚Äî —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –∞–∫—Ç—ã.
*   –í—Å–µ **stateless** ‚Üí –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –≤ Kubernetes.

## 5. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–∂–Ω–æ –≥–æ—Ä–¥–∏—Ç—å—Å—è
*   ü•á **Zero loss** –ø—Ä–∏ 10 000+ msg/–¥–µ–Ω—å.
*   ‚è± **P95** 170 –º—Å –ø—Ä–æ—Ç–∏–≤ –±—ã–≤—à–∏—Ö 208 –º—Å.
*   üîÑ **Zero-downtime deploys**, **MTTR** *(Mean Time to Recovery)* ‚Üì –≤ 2.3 —Ä–∞–∑–∞.
*   üìä –î–∞—à–±–æ—Ä–¥—ã ‚Üí –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã –ª–æ–≤–∏–º –¥–æ –∂–∞–ª–æ–± –∫–ª–∏–µ–Ω—Ç–æ–≤.

## 6. –ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è (–ª–∏—á–Ω—ã–π —Ä–æ—Å—Ç)
*   –†–µ–∞–ª—å–Ω—ã–π **exactly-once**: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ producer + DB.
*   –¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ **partition rebalance** *(–ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –º–µ–∂–¥—É –∫–æ–Ω—Å—å—é–º–µ—Ä–∞–º–∏).*  
*   **SLO-first** –º—ã—à–ª–µ–Ω–∏–µ –∏ ¬´culture of ownership¬ª *(—Ñ–æ–∫—É—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ª–∏—á–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ —Å–µ—Ä–≤–∏—Å).*  

## 7. –ö–∞–∫ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –∑–∞ 60 —Å–µ–∫—É–Ω–¥
> ¬´RabbitMQ –Ω–µ —Ç—è–Ω—É–ª 10k —Å–æ–±—ã—Ç–∏–π/–¥–µ–Ω—å, –±–∏–∑–Ω–µ—Å —Ç–µ—Ä—è–ª –¥–µ–Ω—å–≥–∏. –Ø —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–ª –∫–ª–∞—Å—Ç–µ—Ä Kafka (3 –±—Ä–æ–∫–µ—Ä–∞, RF = 3), –Ω–∞—Å—Ç—Ä–æ–∏–ª exactly-once (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä + —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏), –Ω–∞–ø–∏—Å–∞–ª consumer-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –Ω–∞ Go (Sarama, retry, DLQ), –¥–æ–±–∞–≤–∏–ª Prometheus –∏ Grafana (—Å–ª–µ–¥–∏–º –∑–∞ lag > 1000). –í –∏—Ç–æ–≥–µ: –±–µ–∑ –ø–æ—Ç–µ—Ä—å, SLA 99.98 %, P95 170 –º—Å, –≤—ã–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞. –ù–∞—É—á–∏–ª—Å—è —É–ø—Ä–∞–≤–ª—è—Ç—å partition rebalance –∏ —Å—Ç—Ä–æ–∏—Ç—å SLO-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥¬ª.

---
### –ü–æ–¥—Å–∫–∞–∑–∫–∞: —á–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ–º
- [ ] –£–º–µ—Ç—å –æ–±—ä—è—Å–Ω–∏—Ç—å **exactly-once**.
- [ ] –ü–æ—á–µ–º—É partition = `policy_id`.
- [ ] –ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–µ—Ä–∂–∏–º –ø–æ–¥ –∞–ª–µ—Ä—Ç–∞–º–∏ (lag, throughput, error rate).
- [ ] –ö–∞–∫ –¥–µ–ª–∞–µ—Ç—Å—è rollback –ø—Ä–∏ fail –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ Producer + DB.
- [ ] –ß–µ–º Kafka –ª—É—á—à–µ RabbitMQ –¥–ª—è event streaming.


–ù–∞–¥–µ—é—Å—å, —ç—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –≤–∞–º –ø–æ–ª–µ–∑–Ω–∞!

